<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafeâ˜…Log - åº—èˆ—ãƒªã‚¹ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #00704A;
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel h2 {
            color: #00704A;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            border-bottom: 2px solid #00704A;
            padding-bottom: 0.5rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #00704A;
        }

        .input-group textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            background: #00704A;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.2s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn:hover {
            background: #005a38;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .coordinate-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .coordinate-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .coord-method {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
        }

        .coord-method:hover {
            border-color: #00704A;
        }

        .coord-method.active {
            border-color: #00704A;
            background: #f8fff8;
        }

        .store-list {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .store-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #00704A;
        }

        .store-item h4 {
            color: #00704A;
            margin-bottom: 0.5rem;
        }

        .store-item .store-details {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .store-item .coordinates {
            font-family: monospace;
            font-size: 0.8rem;
            background: white;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .validation-status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .validation-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .validation-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .validation-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00704A;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .export-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: #00704A;
            transition: width 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .manual-adjustment-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .manual-adjustment-item h4 {
            color: #856404;
            margin-bottom: 0.5rem;
        }

        .adjustment-reason {
            font-size: 0.8rem;
            color: #856404;
            margin-bottom: 1rem;
        }

        .adjustment-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }

        .places-suggestion {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .places-suggestion h5 {
            color: #0c5460;
            margin-bottom: 0.5rem;
        }

        .confidence-score {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .confidence-high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }

        .enrichment-progress {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00704A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 0.3rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .coordinate-methods {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â˜• Cafeâ˜…Log åº—èˆ—ãƒªã‚¹ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</h1>
            <p>æ­£ç¢ºãªåº§æ¨™æƒ…å ±ã¨å“è³ªç®¡ç†æ©Ÿèƒ½ã‚’å‚™ãˆãŸåº—èˆ—ãƒ‡ãƒ¼ã‚¿ä½œæˆã‚·ã‚¹ãƒ†ãƒ </p>
        </div>

        <div class="main-content">
            <!-- åº—èˆ—å…¥åŠ›ãƒ‘ãƒãƒ« -->
            <div class="panel">
                <h2>ğŸ“ åº—èˆ—æƒ…å ±å…¥åŠ›</h2>
                
                <div class="input-group">
                    <label for="storeName">åº—èˆ—å *</label>
                    <input type="text" id="storeName" placeholder="ä¾‹: ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«ã‚¹ã‚¯ã‚¨ã‚¢åº—">
                    <div class="error-message hidden" id="storeNameError"></div>
                </div>

                <div class="input-group">
                    <label for="storeAddress">ä½æ‰€ *</label>
                    <input type="text" id="storeAddress" placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·2-24-12">
                    <div class="error-message hidden" id="storeAddressError"></div>
                </div>

                <div class="input-group">
                    <label for="storePrefecture">éƒ½é“åºœçœŒ *</label>
                    <select id="storePrefecture">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
                        <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
                        <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
                        <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
                        <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
                        <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
                        <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
                        <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
                        <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
                        <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
                        <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
                        <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
                        <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                        <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
                        <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
                        <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
                        <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
                        <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
                        <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
                        <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
                        <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
                        <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
                        <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
                        <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
                        <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
                        <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
                        <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
                        <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
                        <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
                        <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
                        <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
                        <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
                        <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
                        <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
                        <option value="å±±å£çœŒ">å±±å£çœŒ</option>
                        <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
                        <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
                        <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
                        <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
                        <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
                        <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
                        <option value="é•·å´çœŒ">é•·å´çœŒ</option>
                        <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
                        <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
                        <option value="å®®å´çœŒ">å®®å´çœŒ</option>
                        <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
                        <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="storePhone">é›»è©±ç•ªå·</label>
                    <input type="tel" id="storePhone" placeholder="ä¾‹: 03-1234-5678">
                </div>

                <div class="input-group">
                    <label for="storeHours">å–¶æ¥­æ™‚é–“</label>
                    <input type="text" id="storeHours" placeholder="ä¾‹: å¹³æ—¥ 6:30-22:30">
                </div>

                <!-- åº§æ¨™å–å¾—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="coordinate-section">
                    <h3>ğŸ—ºï¸ åº§æ¨™å–å¾—æ–¹æ³•</h3>
                    <div class="coordinate-methods">
                        <div class="coord-method active" data-method="auto">
                            <h4>è‡ªå‹•å–å¾—</h4>
                            <p>ä½æ‰€ã‹ã‚‰è‡ªå‹•ã§åº§æ¨™ã‚’å–å¾—</p>
                        </div>
                        <div class="coord-method" data-method="manual">
                            <h4>æ‰‹å‹•å…¥åŠ›</h4>
                            <p>ç·¯åº¦ãƒ»çµŒåº¦ã‚’ç›´æ¥å…¥åŠ›</p>
                        </div>
                    </div>

                    <div id="autoCoordinates">
                        <button type="button" class="btn" onclick="getCoordinatesFromAddress()">
                            ğŸ“ ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—
                        </button>
                        <div class="validation-status hidden" id="coordinateStatus"></div>
                    </div>

                    <div id="manualCoordinates" class="hidden">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="input-group">
                                <label for="latitude">ç·¯åº¦ *</label>
                                <input type="number" id="latitude" step="0.000001" placeholder="35.658581">
                            </div>
                            <div class="input-group">
                                <label for="longitude">çµŒåº¦ *</label>
                                <input type="number" id="longitude" step="0.000001" placeholder="139.701762">
                            </div>
                        </div>
                        <button type="button" class="btn-secondary btn" onclick="validateManualCoordinates()">
                            âœ“ åº§æ¨™ã‚’æ¤œè¨¼
                        </button>
                    </div>
                </div>

                <div class="input-group">
                    <label for="storeFeatures">ç‰¹å¾´ãƒ»è¨­å‚™</label>
                    <textarea id="storeFeatures" placeholder="ä¾‹: Wi-Fi, é›»æº, ç¦ç…™, ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¹ãƒ«ãƒ¼"></textarea>
                </div>

                <div style="text-align: center;">
                    <button type="button" class="btn" onclick="addStore()">
                        â• åº—èˆ—ã‚’è¿½åŠ 
                    </button>
                    <button type="button" class="btn-secondary btn" onclick="clearForm()">
                        ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                    </button>
                </div>

                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e9ecef;">
                    <h3 style="color: #00704A; margin-bottom: 1rem;">ğŸ¤– è‡ªå‹•ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                        å…¨å›½ã®ä¸»è¦ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ã§ç”Ÿæˆã—ã¾ã™
                    </p>
                    <button type="button" class="btn" onclick="generateAllStores()" style="background: #28a745; width: 100%;">
                        ğŸš€ å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆ
                    </button>
                    <div class="validation-status hidden" id="autoGenerationStatus"></div>
                    <div class="progress-bar hidden" id="autoGenerationProgress">
                        <div class="progress-fill" id="autoGenerationProgressFill"></div>
                    </div>
                </div>
            </div>

            <!-- å“è³ªç®¡ç†ãƒ‘ãƒãƒ« -->
            <div class="panel">
                <h2>âœ… å“è³ªç®¡ç†</h2>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalStores">0</div>
                        <div class="stat-label">ç·åº—èˆ—æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="validStores">0</div>
                        <div class="stat-label">æ¤œè¨¼æ¸ˆã¿</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="duplicateStores">0</div>
                        <div class="stat-label">é‡è¤‡æ¤œå‡º</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="errorStores">0</div>
                        <div class="stat-label">ã‚¨ãƒ©ãƒ¼</div>
                    </div>
                </div>

                <button type="button" class="btn" onclick="validateAllStores()">
                    ğŸ” å…¨åº—èˆ—æ¤œè¨¼
                </button>
                <button type="button" class="btn-secondary btn" onclick="removeDuplicates()">
                    ğŸ§¹ é‡è¤‡å‰Šé™¤
                </button>
                <button type="button" class="btn" onclick="enrichWithPlacesAPI()" style="background: #17a2b8;">
                    ğŸŒ Places API ã§æƒ…å ±è£œå®Œ
                </button>
                <button type="button" class="btn-danger btn" onclick="clearAllStores()">
                    ğŸ—‘ï¸ å…¨å‰Šé™¤
                </button>

                <div class="validation-status hidden" id="globalValidationStatus"></div>

                <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ªãƒ¬ãƒãƒ¼ãƒˆ</h3>
                <div id="qualityReport"></div>

                <h3>âš ï¸ è¦æ‰‹å‹•èª¿æ•´åº—èˆ—</h3>
                <div id="manualAdjustmentList"></div>
            </div>
        </div>

        <!-- åº—èˆ—ãƒªã‚¹ãƒˆè¡¨ç¤º -->
        <div class="store-list">
            <h2>ğŸ“‹ ç™»éŒ²æ¸ˆã¿åº—èˆ—ãƒªã‚¹ãƒˆ</h2>
            <div id="storeListContainer">
                <p style="text-align: center; color: #666; margin: 2rem 0;">
                    ã¾ã åº—èˆ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
                </p>
            </div>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="export-section">
            <h2>ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
            
            <div class="input-group">
                <label for="dataVersion">ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³</label>
                <input type="text" id="dataVersion" value="2.1.0" placeholder="ä¾‹: 2.1.0">
            </div>

            <div class="input-group">
                <label for="coverageDescription">ã‚«ãƒãƒ¬ãƒƒã‚¸èª¬æ˜</label>
                <input type="text" id="coverageDescription" placeholder="ä¾‹: å…¨å›½47éƒ½é“åºœçœŒ">
            </div>

            <button type="button" class="btn" onclick="exportToJSON()">
                ğŸ’¾ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
            </button>
            <button type="button" class="btn-secondary btn" onclick="importFromJSON()">
                ğŸ“‚ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            </button>

            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport()">

            <div class="progress-bar hidden" id="exportProgress">
                <div class="progress-fill" id="exportProgressFill"></div>
            </div>

            <div class="validation-status hidden" id="exportStatus"></div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script>
        let map, geocoder, stores = [];
        let currentCoordinateMethod = 'auto';

        // éƒ½é“åºœçœŒã‹ã‚‰ã‚¨ãƒªã‚¢ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const PREFECTURE_TO_AREA = {
            'åŒ—æµ·é“': 'åŒ—æµ·é“',
            'é’æ£®çœŒ': 'æ±åŒ—', 'å²©æ‰‹çœŒ': 'æ±åŒ—', 'å®®åŸçœŒ': 'æ±åŒ—', 'ç§‹ç”°çœŒ': 'æ±åŒ—', 'å±±å½¢çœŒ': 'æ±åŒ—', 'ç¦å³¶çœŒ': 'æ±åŒ—',
            'èŒ¨åŸçœŒ': 'é–¢æ±', 'æ ƒæœ¨çœŒ': 'é–¢æ±', 'ç¾¤é¦¬çœŒ': 'é–¢æ±', 'åŸ¼ç‰çœŒ': 'é–¢æ±', 'åƒè‘‰çœŒ': 'é–¢æ±', 'æ±äº¬éƒ½': 'é–¢æ±', 'ç¥å¥ˆå·çœŒ': 'é–¢æ±',
            'æ–°æ½ŸçœŒ': 'ä¸­éƒ¨', 'å¯Œå±±çœŒ': 'ä¸­éƒ¨', 'çŸ³å·çœŒ': 'ä¸­éƒ¨', 'ç¦äº•çœŒ': 'ä¸­éƒ¨', 'å±±æ¢¨çœŒ': 'ä¸­éƒ¨', 'é•·é‡çœŒ': 'ä¸­éƒ¨', 'å²é˜œçœŒ': 'ä¸­éƒ¨', 'é™å²¡çœŒ': 'ä¸­éƒ¨', 'æ„›çŸ¥çœŒ': 'ä¸­éƒ¨',
            'ä¸‰é‡çœŒ': 'è¿‘ç•¿', 'æ»‹è³€çœŒ': 'è¿‘ç•¿', 'äº¬éƒ½åºœ': 'è¿‘ç•¿', 'å¤§é˜ªåºœ': 'è¿‘ç•¿', 'å…µåº«çœŒ': 'è¿‘ç•¿', 'å¥ˆè‰¯çœŒ': 'è¿‘ç•¿', 'å’Œæ­Œå±±çœŒ': 'è¿‘ç•¿',
            'é³¥å–çœŒ': 'ä¸­å›½', 'å³¶æ ¹çœŒ': 'ä¸­å›½', 'å²¡å±±çœŒ': 'ä¸­å›½', 'åºƒå³¶çœŒ': 'ä¸­å›½', 'å±±å£çœŒ': 'ä¸­å›½',
            'å¾³å³¶çœŒ': 'å››å›½', 'é¦™å·çœŒ': 'å››å›½', 'æ„›åª›çœŒ': 'å››å›½', 'é«˜çŸ¥çœŒ': 'å››å›½',
            'ç¦å²¡çœŒ': 'ä¹å·', 'ä½è³€çœŒ': 'ä¹å·', 'é•·å´çœŒ': 'ä¹å·', 'ç†Šæœ¬çœŒ': 'ä¹å·', 'å¤§åˆ†çœŒ': 'ä¹å·', 'å®®å´çœŒ': 'ä¹å·', 'é¹¿å…å³¶çœŒ': 'ä¹å·', 'æ²–ç¸„çœŒ': 'ä¹å·'
        };

        function initMap() {
            geocoder = new google.maps.Geocoder();
            console.log('âœ… Google Maps API initialized');
        }

        // åº§æ¨™å–å¾—æ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.coord-method').forEach(method => {
            method.addEventListener('click', function() {
                const selectedMethod = this.dataset.method;
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.coord-method').forEach(m => m.classList.remove('active'));
                this.classList.add('active');
                
                // ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('autoCoordinates').classList.toggle('hidden', selectedMethod !== 'auto');
                document.getElementById('manualCoordinates').classList.toggle('hidden', selectedMethod !== 'manual');
                
                currentCoordinateMethod = selectedMethod;
            });
        });

        // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ï¼ˆé«˜ç²¾åº¦ï¼‰
        async function getCoordinatesFromAddress() {
            const address = document.getElementById('storeAddress').value.trim();
            const storeName = document.getElementById('storeName').value.trim();
            
            if (!address) {
                showCoordinateStatus('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showCoordinateStatus('åº§æ¨™ã‚’å–å¾—ä¸­...', 'loading');

            try {
                // è¤‡æ•°ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã§ç²¾åº¦å‘ä¸Š
                const queries = [
                    `${storeName} ${address}`,  // åº—å + ä½æ‰€
                    address,                    // ä½æ‰€ã®ã¿
                    address.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))  // å…¨è§’â†’åŠè§’å¤‰æ›
                ];

                let bestResult = null;
                let bestAccuracy = 0;

                for (const query of queries) {
                    try {
                        const result = await geocodeAddress(query);
                        if (result && result.accuracy > bestAccuracy) {
                            bestResult = result;
                            bestAccuracy = result.accuracy;
                        }
                    } catch (e) {
                        console.log(`Geocoding failed for query: ${query}`);
                    }
                }

                if (bestResult) {
                    document.getElementById('latitude').value = bestResult.lat.toFixed(6);
                    document.getElementById('longitude').value = bestResult.lng.toFixed(6);
                    
                    showCoordinateStatus(
                        `âœ… åº§æ¨™å–å¾—æˆåŠŸ (ç²¾åº¦: ${getAccuracyText(bestAccuracy)})`,
                        'success'
                    );
                } else {
                    throw new Error('åº§æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

            } catch (error) {
                console.error('Geocoding error:', error);
                showCoordinateStatus(`âŒ åº§æ¨™å–å¾—å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // Geocoding Promise wrapper
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address: address, region: 'JP' }, (results, status) => {
                    if (status === 'OK' && results.length > 0) {
                        const result = results[0];
                        const location = result.geometry.location;
                        
                        // ç²¾åº¦åˆ¤å®šï¼ˆlocation_typeã‹ã‚‰ï¼‰
                        let accuracy = 0;
                        switch (result.geometry.location_type) {
                            case 'ROOFTOP': accuracy = 10; break;           // å»ºç‰©ãƒ¬ãƒ™ãƒ«
                            case 'RANGE_INTERPOLATED': accuracy = 8; break; // ç•ªåœ°ãƒ¬ãƒ™ãƒ«
                            case 'GEOMETRIC_CENTER': accuracy = 6; break;   // åœ°åŒºãƒ¬ãƒ™ãƒ«
                            case 'APPROXIMATE': accuracy = 4; break;        // æ¦‚ç®—
                        }

                        // ä½æ‰€ã‚¿ã‚¤ãƒ—ã‹ã‚‰ã®ç²¾åº¦åŠ ç®—
                        const addressTypes = result.types;
                        if (addressTypes.includes('establishment')) accuracy += 2;
                        if (addressTypes.includes('premise')) accuracy += 1;

                        resolve({
                            lat: location.lat(),
                            lng: location.lng(),
                            accuracy: accuracy,
                            formatted_address: result.formatted_address,
                            location_type: result.geometry.location_type
                        });
                    } else {
                        reject(new Error(`Geocoding failed: ${status}`));
                    }
                });
            });
        }

        function getAccuracyText(accuracy) {
            if (accuracy >= 9) return 'éå¸¸ã«é«˜ã„';
            if (accuracy >= 7) return 'é«˜ã„';
            if (accuracy >= 5) return 'ä¸­ç¨‹åº¦';
            return 'ä½ã„';
        }

        // æ‰‹å‹•åº§æ¨™ã®æ¤œè¨¼
        async function validateManualCoordinates() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);

            if (isNaN(lat) || isNaN(lng)) {
                showCoordinateStatus('âŒ æœ‰åŠ¹ãªç·¯åº¦ãƒ»çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // æ—¥æœ¬ã®å¢ƒç•Œãƒã‚§ãƒƒã‚¯
            if (lat < 20 || lat > 46 || lng < 123 || lng > 146) {
                showCoordinateStatus('âš ï¸ åº§æ¨™ãŒæ—¥æœ¬ã®ç¯„å›²å¤–ã§ã™', 'warning');
                return;
            }

            // é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ä½æ‰€ç¢ºèª
            try {
                const reverseResult = await reverseGeocode(lat, lng);
                if (reverseResult) {
                    showCoordinateStatus(
                        `âœ… åº§æ¨™æ¤œè¨¼æˆåŠŸ: ${reverseResult.formatted_address}`,
                        'success'
                    );
                } else {
                    showCoordinateStatus('âš ï¸ åº§æ¨™ã¯æœ‰åŠ¹ã§ã™ãŒã€ä½æ‰€æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                }
            } catch (error) {
                showCoordinateStatus('âš ï¸ åº§æ¨™ã¯æœ‰åŠ¹ã§ã™ãŒã€æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'warning');
            }
        }

        // é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
        function reverseGeocode(lat, lng) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                    if (status === 'OK' && results.length > 0) {
                        resolve(results[0]);
                    } else {
                        reject(new Error(`Reverse geocoding failed: ${status}`));
                    }
                });
            });
        }

        // åº§æ¨™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showCoordinateStatus(message, type) {
            const statusElement = document.getElementById('coordinateStatus');
            statusElement.textContent = message;
            statusElement.className = `validation-status ${type}`;
            statusElement.classList.remove('hidden');
        }

        // åº—èˆ—è¿½åŠ 
        async function addStore() {
            if (!validateForm()) {
                return;
            }

            const storeData = collectFormData();
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (isDuplicate(storeData)) {
                showGlobalStatus('âš ï¸ åŒã˜åº—èˆ—ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'warning');
                return;
            }

            // åº—èˆ—IDç”Ÿæˆ
            storeData.storeInfo.id = generateStoreId(storeData);

            stores.push(storeData);
            updateStoreList();
            updateStats();
            clearForm();
            
            showGlobalStatus('âœ… åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼
        function validateForm() {
            let isValid = true;
            const errors = {};

            // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
            const storeName = document.getElementById('storeName').value.trim();
            if (!storeName) {
                errors.storeName = 'åº—èˆ—åã¯å¿…é ˆã§ã™';
                isValid = false;
            }

            const storeAddress = document.getElementById('storeAddress').value.trim();
            if (!storeAddress) {
                errors.storeAddress = 'ä½æ‰€ã¯å¿…é ˆã§ã™';
                isValid = false;
            }

            const prefecture = document.getElementById('storePrefecture').value;
            if (!prefecture) {
                errors.storePrefecture = 'éƒ½é“åºœçœŒã¯å¿…é ˆã§ã™';
                isValid = false;
            }

            // åº§æ¨™ãƒã‚§ãƒƒã‚¯
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            if (isNaN(lat) || isNaN(lng)) {
                errors.coordinates = 'åº§æ¨™æƒ…å ±ãŒå¿…è¦ã§ã™';
                isValid = false;
            }

            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            Object.keys(errors).forEach(field => {
                const errorElement = document.getElementById(field + 'Error');
                if (errorElement) {
                    errorElement.textContent = errors[field];
                    errorElement.classList.remove('hidden');
                }
            });

            // ã‚¨ãƒ©ãƒ¼ã®ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.error-message').forEach(el => {
                const fieldName = el.id.replace('Error', '');
                if (!errors[fieldName]) {
                    el.classList.add('hidden');
                }
            });

            return isValid;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
        function collectFormData() {
            const prefecture = document.getElementById('storePrefecture').value;
            const features = document.getElementById('storeFeatures').value
                .split(',')
                .map(f => f.trim())
                .filter(f => f.length > 0);

            return {
                storeInfo: {
                    id: '', // å¾Œã§ç”Ÿæˆ
                    name: document.getElementById('storeName').value.trim(),
                    address: document.getElementById('storeAddress').value.trim(),
                    coordinates: {
                        latitude: parseFloat(document.getElementById('latitude').value),
                        longitude: parseFloat(document.getElementById('longitude').value)
                    },
                    prefecture: prefecture,
                    city: extractCity(document.getElementById('storeAddress').value.trim()),
                    area: PREFECTURE_TO_AREA[prefecture] || 'ä¸æ˜'
                },
                businessInfo: {
                    hours: document.getElementById('storeHours').value.trim() || null,
                    phone: document.getElementById('storePhone').value.trim() || null,
                    features: features
                }
            };
        }

        // å¸‚åŒºç”ºæ‘æŠ½å‡º
        function extractCity(address) {
            const cityMatch = address.match(/([^éƒ½é“åºœçœŒ]+[éƒ½é“åºœçœŒ])(.+?[å¸‚åŒºç”ºæ‘])/);
            return cityMatch ? cityMatch[2] : '';
        }

        // åº—èˆ—IDç”Ÿæˆ
        function generateStoreId(storeData) {
            const prefecture = storeData.storeInfo.prefecture.replace(/[éƒ½é“åºœçœŒ]/g, '');
            const city = storeData.storeInfo.city.replace(/[å¸‚åŒºç”ºæ‘]/g, '');
            const storeName = storeData.storeInfo.name
                .replace(/ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹|ã‚³ãƒ¼ãƒ’ãƒ¼|åº—/g, '')
                .trim();

            // æ—¢å­˜IDã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            let counter = 1;
            let baseId = `store_${prefecture}_${city}_${storeName}`.toLowerCase()
                .replace(/[^a-z0-9_]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');

            let finalId = baseId;
            while (stores.some(store => store.storeInfo.id === finalId)) {
                finalId = `${baseId}_${String(counter).padStart(3, '0')}`;
                counter++;
            }

            return finalId;
        }

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        function isDuplicate(newStore) {
            return stores.some(existingStore => {
                // åå‰ã¨ä½æ‰€ãŒå®Œå…¨ä¸€è‡´
                if (existingStore.storeInfo.name === newStore.storeInfo.name &&
                    existingStore.storeInfo.address === newStore.storeInfo.address) {
                    return true;
                }

                // åº§æ¨™ãŒ50mä»¥å†…
                const distance = calculateDistance(
                    existingStore.storeInfo.coordinates,
                    newStore.storeInfo.coordinates
                );
                return distance < 0.05; // 50m = 0.05km
            });
        }

        // è·é›¢è¨ˆç®—ï¼ˆHaversine formulaï¼‰
        function calculateDistance(coord1, coord2) {
            const R = 6371; // åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰
            const dLat = (coord2.latitude - coord1.latitude) * Math.PI / 180;
            const dLon = (coord2.longitude - coord1.longitude) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coord1.latitude * Math.PI / 180) * Math.cos(coord2.latitude * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // åº—èˆ—ãƒªã‚¹ãƒˆæ›´æ–°
        function updateStoreList() {
            const container = document.getElementById('storeListContainer');
            
            if (stores.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 2rem 0;">ã¾ã åº—èˆ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = stores.map((store, index) => `
                <div class="store-item">
                    <h4>${store.storeInfo.name}</h4>
                    <div class="store-details">
                        ğŸ“ ${store.storeInfo.address}<br>
                        ğŸ  ${store.storeInfo.prefecture} ${store.storeInfo.city} (${store.storeInfo.area})<br>
                        ${store.businessInfo.phone ? `ğŸ“ ${store.businessInfo.phone}<br>` : ''}
                        ${store.businessInfo.hours ? `ğŸ•’ ${store.businessInfo.hours}<br>` : ''}
                        ${store.businessInfo.features.length > 0 ? `ğŸ·ï¸ ${store.businessInfo.features.join(', ')}` : ''}
                    </div>
                    <div class="coordinates">
                        ID: ${store.storeInfo.id}<br>
                        åº§æ¨™: ${store.storeInfo.coordinates.latitude.toFixed(6)}, ${store.storeInfo.coordinates.longitude.toFixed(6)}
                    </div>
                    <button type="button" class="btn-danger btn" onclick="removeStore(${index})" style="margin-top: 0.5rem;">
                        ğŸ—‘ï¸ å‰Šé™¤
                    </button>
                </div>
            `).join('');
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            document.getElementById('totalStores').textContent = stores.length;
            document.getElementById('validStores').textContent = stores.length; // è¿½åŠ æ™‚ç‚¹ã§æ¤œè¨¼æ¸ˆã¿
            document.getElementById('duplicateStores').textContent = findDuplicates().length;
            document.getElementById('errorStores').textContent = 0; // è¿½åŠ æ™‚ç‚¹ã§ã‚¨ãƒ©ãƒ¼ãªã—
        }

        // åº—èˆ—å‰Šé™¤
        function removeStore(index) {
            if (confirm('ã“ã®åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                stores.splice(index, 1);
                updateStoreList();
                updateStats();
                showGlobalStatus('âœ… åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
        function clearForm() {
            document.getElementById('storeName').value = '';
            document.getElementById('storeAddress').value = '';
            document.getElementById('storePrefecture').value = '';
            document.getElementById('storePhone').value = '';
            document.getElementById('storeHours').value = '';
            document.getElementById('storeFeatures').value = '';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
            document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
            document.getElementById('coordinateStatus').classList.add('hidden');
        }

        // å…¨åº—èˆ—å‰Šé™¤
        function clearAllStores() {
            if (confirm('å…¨ã¦ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                stores = [];
                updateStoreList();
                updateStats();
                showGlobalStatus('âœ… å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // é‡è¤‡æ¤œå‡º
        function findDuplicates() {
            const duplicates = [];
            for (let i = 0; i < stores.length; i++) {
                for (let j = i + 1; j < stores.length; j++) {
                    if (isDuplicate(stores[i])) {
                        duplicates.push({ index1: i, index2: j });
                    }
                }
            }
            return duplicates;
        }

        // é‡è¤‡å‰Šé™¤
        function removeDuplicates() {
            const duplicates = findDuplicates();
            if (duplicates.length === 0) {
                showGlobalStatus('âœ… é‡è¤‡ã™ã‚‹åº—èˆ—ã¯ã‚ã‚Šã¾ã›ã‚“', 'success');
                return;
            }

            if (confirm(`${duplicates.length}çµ„ã®é‡è¤‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                // é‡è¤‡ã®2ã¤ç›®ã‚’å‰Šé™¤ï¼ˆé€†é †ã§å‰Šé™¤ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãšã‚Œã‚’é˜²ãï¼‰
                const indicesToRemove = duplicates.map(d => d.index2).sort((a, b) => b - a);
                indicesToRemove.forEach(index => stores.splice(index, 1));
                
                updateStoreList();
                updateStats();
                showGlobalStatus(`âœ… ${indicesToRemove.length}ä»¶ã®é‡è¤‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
            }
        }

        // å…¨åº—èˆ—æ¤œè¨¼
        function validateAllStores() {
            const report = {
                total: stores.length,
                valid: 0,
                warnings: [],
                errors: []
            };

            stores.forEach((store, index) => {
                // åŸºæœ¬çš„ãªæ¤œè¨¼
                if (!store.storeInfo.name || !store.storeInfo.address) {
                    report.errors.push(`åº—èˆ— ${index + 1}: å¿…é ˆé …ç›®ãŒä¸è¶³`);
                    return;
                }

                // åº§æ¨™æ¤œè¨¼
                const lat = store.storeInfo.coordinates.latitude;
                const lng = store.storeInfo.coordinates.longitude;
                if (isNaN(lat) || isNaN(lng)) {
                    report.errors.push(`åº—èˆ— ${index + 1}: åº§æ¨™ãŒç„¡åŠ¹`);
                    return;
                }

                if (lat < 20 || lat > 46 || lng < 123 || lng > 146) {
                    report.warnings.push(`åº—èˆ— ${index + 1}: åº§æ¨™ãŒæ—¥æœ¬ã®ç¯„å›²å¤–ã®å¯èƒ½æ€§`);
                }

                report.valid++;
            });

            // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
            updateQualityReport(report);
            showGlobalStatus(`âœ… æ¤œè¨¼å®Œäº†: ${report.valid}/${report.total}ä»¶ãŒæœ‰åŠ¹`, 'success');
        }

        // å“è³ªãƒ¬ãƒãƒ¼ãƒˆæ›´æ–°
        function updateQualityReport(report) {
            const reportContainer = document.getElementById('qualityReport');
            
            let html = `
                <div style="margin: 1rem 0;">
                    <h4>æ¤œè¨¼çµæœ</h4>
                    <p>æœ‰åŠ¹: ${report.valid}/${report.total}ä»¶</p>
                </div>
            `;

            if (report.warnings.length > 0) {
                html += `
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h5>âš ï¸ è­¦å‘Š (${report.warnings.length}ä»¶)</h5>
                        <ul>
                            ${report.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (report.errors.length > 0) {
                html += `
                    <div style="background: #f8d7da; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h5>âŒ ã‚¨ãƒ©ãƒ¼ (${report.errors.length}ä»¶)</h5>
                        <ul>
                            ${report.errors.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (report.warnings.length === 0 && report.errors.length === 0) {
                html += `
                    <div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h5>âœ… å•é¡Œãªã—</h5>
                        <p>å…¨ã¦ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒæœ‰åŠ¹ã§ã™ã€‚</p>
                    </div>
                `;
            }

            reportContainer.innerHTML = html;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showGlobalStatus(message, type) {
            const statusElement = document.getElementById('globalValidationStatus');
            statusElement.textContent = message;
            statusElement.className = `validation-status ${type}`;
            statusElement.classList.remove('hidden');
            
            // 3ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 3000);
        }

        // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToJSON() {
            if (stores.length === 0) {
                showExportStatus('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const dataVersion = document.getElementById('dataVersion').value.trim() || '2.1.0';
            const coverageDescription = document.getElementById('coverageDescription').value.trim() || 'åº—èˆ—ãƒ‡ãƒ¼ã‚¿';

            const exportData = {
                metadata: {
                    dataVersion: {
                        current: dataVersion,
                        compatible: [dataVersion]
                    },
                    generatedAt: new Date().toISOString(),
                    totalStores: stores.length,
                    coverage: coverageDescription,
                    generator: 'Cafeâ˜…Log Store List Creator Tool'
                },
                stores: stores,
                migrationSupport: {
                    legacyIdMapping: {},
                    deprecatedFields: []
                }
            };

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cafe-log-stores-v${dataVersion}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showExportStatus('âœ… JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
        }

        // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importFromJSON() {
            document.getElementById('importFile').click();
        }

        function handleFileImport() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // ãƒ‡ãƒ¼ã‚¿å½¢å¼æ¤œè¨¼
                    if (!importData.stores || !Array.isArray(importData.stores)) {
                        throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
                    }

                    if (confirm(`${importData.stores.length}ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚`)) {
                        stores = importData.stores;
                        updateStoreList();
                        updateStats();
                        
                        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                        if (importData.metadata) {
                            document.getElementById('dataVersion').value = importData.metadata.dataVersion.current || '2.1.0';
                            document.getElementById('coverageDescription').value = importData.metadata.coverage || '';
                        }

                        showExportStatus('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
                    }
                } catch (error) {
                    showExportStatus(`âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showExportStatus(message, type) {
            const statusElement = document.getElementById('exportStatus');
            statusElement.textContent = message;
            statusElement.className = `validation-status ${type}`;
            statusElement.classList.remove('hidden');
            
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 5000);
        }

        // å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ç”Ÿæˆ
        async function generateAllStores() {
            if (stores.length > 0 && !confirm('æ—¢å­˜ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ã™ã¹ã¦å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            const storeTemplates = getSampleStoreData();
            
            // UIæ›´æ–°
            showAutoGenerationStatus('ğŸš€ å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­...', 'loading');
            showAutoGenerationProgress(0);
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
            stores = [];
            
            try {
                for (let i = 0; i < storeTemplates.length; i++) {
                    const template = storeTemplates[i];
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                    const progress = ((i + 1) / storeTemplates.length) * 100;
                    showAutoGenerationProgress(progress);
                    showAutoGenerationStatus(`ğŸ“ å‡¦ç†ä¸­ ${i + 1}/${storeTemplates.length}: ${template.name}`, 'loading');
                    
                    try {
                        // åº§æ¨™å–å¾—
                        const coordinates = await getCoordinatesForTemplate(template);
                        
                        if (coordinates) {
                            const storeData = {
                                storeInfo: {
                                    id: generateStoreId({
                                        storeInfo: {
                                            name: template.name,
                                            prefecture: template.prefecture,
                                            city: template.city
                                        }
                                    }),
                                    name: template.name,
                                    address: template.address,
                                    coordinates: coordinates,
                                    prefecture: template.prefecture,
                                    city: template.city,
                                    area: PREFECTURE_TO_AREA[template.prefecture] || 'ä¸æ˜'
                                },
                                businessInfo: {
                                    hours: template.hours || null,
                                    phone: template.phone || null,
                                    features: template.features || ['Wi-Fi', 'é›»æº', 'ç¦ç…™']
                                }
                            };
                            
                            stores.push(storeData);
                        } else {
                            console.warn(`åº§æ¨™å–å¾—å¤±æ•—: ${template.name}`);
                        }
                        
                        // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (error) {
                        console.error(`åº—èˆ—å‡¦ç†ã‚¨ãƒ©ãƒ¼ (${template.name}):`, error);
                    }
                }
                
                // å®Œäº†å‡¦ç†
                updateStoreList();
                updateStats();
                showAutoGenerationProgress(100);
                showAutoGenerationStatus(`âœ… ç”Ÿæˆå®Œäº†ï¼ ${stores.length}åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸ`, 'success');
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’3ç§’å¾Œã«éè¡¨ç¤º
                setTimeout(() => {
                    document.getElementById('autoGenerationProgress').classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                console.error('è‡ªå‹•ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                showAutoGenerationStatus(`âŒ ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨åº§æ¨™å–å¾—
        async function getCoordinatesForTemplate(template) {
            try {
                const result = await geocodeAddress(template.address);
                if (result && result.accuracy >= 4) {
                    return {
                        latitude: result.lat,
                        longitude: result.lng
                    };
                }
                return null;
            } catch (error) {
                console.error(`åº§æ¨™å–å¾—ã‚¨ãƒ©ãƒ¼ (${template.name}):`, error);
                return null;
            }
        }

        // è‡ªå‹•ç”Ÿæˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showAutoGenerationStatus(message, type) {
            const statusElement = document.getElementById('autoGenerationStatus');
            statusElement.textContent = message;
            statusElement.className = `validation-status ${type}`;
            statusElement.classList.remove('hidden');
        }

        // è‡ªå‹•ç”Ÿæˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
        function showAutoGenerationProgress(percentage) {
            const progressContainer = document.getElementById('autoGenerationProgress');
            const progressFill = document.getElementById('autoGenerationProgressFill');
            
            progressContainer.classList.remove('hidden');
            progressFill.style.width = `${percentage}%`;
        }

        // ã‚µãƒ³ãƒ—ãƒ«åº—èˆ—ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨å›½ä¸»è¦åº—èˆ—ï¼‰
        function getSampleStoreData() {
            return [
                // åŒ—æµ·é“
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æœ­å¹Œé§…å‰åº—', address: 'åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®åŒºåŒ—3æ¡è¥¿3ä¸ç›®1-1', prefecture: 'åŒ—æµ·é“', city: 'æœ­å¹Œå¸‚', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æ–°åƒæ­³ç©ºæ¸¯åº—', address: 'åŒ—æµ·é“åƒæ­³å¸‚ç¾ã€…987-22', prefecture: 'åŒ—æµ·é“', city: 'åƒæ­³å¸‚', hours: '6:00-21:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                
                // æ±åŒ—
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ ä»™å°é§…åº—', address: 'å®®åŸçœŒä»™å°å¸‚é’è‘‰åŒºä¸­å¤®1ä¸ç›®1-1', prefecture: 'å®®åŸçœŒ', city: 'ä»™å°å¸‚', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ é’æ£®é§…å‰åº—', address: 'é’æ£®çœŒé’æ£®å¸‚æ–°ç”º1ä¸ç›®3-7', prefecture: 'é’æ£®çœŒ', city: 'é’æ£®å¸‚', hours: '7:00-21:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                
                // é–¢æ±
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«ã‚¹ã‚¯ã‚¨ã‚¢åº—', address: 'æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·2-24-12', prefecture: 'æ±äº¬éƒ½', city: 'æ¸‹è°·åŒº', hours: '6:30-23:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æ–°å®¿å—å£åº—', address: 'æ±äº¬éƒ½æ–°å®¿åŒºæ–°å®¿3ä¸ç›®38-1', prefecture: 'æ±äº¬éƒ½', city: 'æ–°å®¿åŒº', hours: '6:30-23:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æ±äº¬é§…ä¸¸ã®å†…åŒ—å£åº—', address: 'æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…1ä¸ç›®9-1', prefecture: 'æ±äº¬éƒ½', city: 'åƒä»£ç”°åŒº', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æ¨ªæµœé§…è¥¿å£åº—', address: 'ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚è¥¿åŒºå—å¹¸1ä¸ç›®5-1', prefecture: 'ç¥å¥ˆå·çœŒ', city: 'æ¨ªæµœå¸‚', hours: '6:30-23:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ å¤§å®®é§…æ±å£åº—', address: 'åŸ¼ç‰çœŒã•ã„ãŸã¾å¸‚å¤§å®®åŒºå¤§é–€ç”º1ä¸ç›®90', prefecture: 'åŸ¼ç‰çœŒ', city: 'ã•ã„ãŸã¾å¸‚', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ åƒè‘‰é§…å‰åº—', address: 'åƒè‘‰çœŒåƒè‘‰å¸‚ä¸­å¤®åŒºæ–°ç”º1000', prefecture: 'åƒè‘‰çœŒ', city: 'åƒè‘‰å¸‚', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                
                // ä¸­éƒ¨
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ åå¤å±‹é§…æ¡œé€šå£åº—', address: 'æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­æ‘åŒºåé§…1ä¸ç›®1-4', prefecture: 'æ„›çŸ¥çœŒ', city: 'åå¤å±‹å¸‚', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ é‡‘æ²¢é§…åº—', address: 'çŸ³å·çœŒé‡‘æ²¢å¸‚æœ¨ãƒæ–°ä¿ç”º1-1', prefecture: 'çŸ³å·çœŒ', city: 'é‡‘æ²¢å¸‚', hours: '6:30-22:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ é™å²¡é§…å—å£åº—', address: 'é™å²¡çœŒé™å²¡å¸‚é§¿æ²³åŒºå—ç”º18-1', prefecture: 'é™å²¡çœŒ', city: 'é™å²¡å¸‚', hours: '6:30-22:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                
                // è¿‘ç•¿
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ å¤§é˜ªé§…ä¸­å¤®æ”¹æœ­å¤–åº—', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°3ä¸ç›®1-1', prefecture: 'å¤§é˜ªåºœ', city: 'å¤§é˜ªå¸‚', hours: '6:30-23:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ äº¬éƒ½é§…å…«æ¡å£åº—', address: 'äº¬éƒ½åºœäº¬éƒ½å¸‚å—åŒºæ±ä¹æ¡è¥¿å±±ç‹ç”º31', prefecture: 'äº¬éƒ½åºœ', city: 'äº¬éƒ½å¸‚', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ ç¥æˆ¸ä¸‰å®®ã‚»ãƒ³ã‚¿ãƒ¼è¡—åº—', address: 'å…µåº«çœŒç¥æˆ¸å¸‚ä¸­å¤®åŒºä¸‰å®®ç”º1ä¸ç›®5-26', prefecture: 'å…µåº«çœŒ', city: 'ç¥æˆ¸å¸‚', hours: '7:00-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                
                // ä¸­å›½
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ åºƒå³¶é§…å—å£åº—', address: 'åºƒå³¶çœŒåºƒå³¶å¸‚å—åŒºæ¾åŸç”º2-37', prefecture: 'åºƒå³¶çœŒ', city: 'åºƒå³¶å¸‚', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ å²¡å±±é§…æ±å£åº—', address: 'å²¡å±±çœŒå²¡å±±å¸‚åŒ—åŒºé§…å…ƒç”º15-1', prefecture: 'å²¡å±±çœŒ', city: 'å²¡å±±å¸‚', hours: '6:30-22:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                
                // å››å›½
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ é«˜æ¾é§…åº—', address: 'é¦™å·çœŒé«˜æ¾å¸‚æµœãƒç”º1-20', prefecture: 'é¦™å·çœŒ', city: 'é«˜æ¾å¸‚', hours: '7:00-21:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æ¾å±±å¸‚é§…åº—', address: 'æ„›åª›çœŒæ¾å±±å¸‚æ¹Šç”º5ä¸ç›®1-1', prefecture: 'æ„›åª›çœŒ', city: 'æ¾å±±å¸‚', hours: '7:00-21:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                
                // ä¹å·
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ åšå¤šé§…ãƒã‚¤ãƒ³ã‚°åº—', address: 'ç¦å²¡çœŒç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…ä¸­å¤®è¡—1-1', prefecture: 'ç¦å²¡çœŒ', city: 'ç¦å²¡å¸‚', hours: '6:30-22:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ ç†Šæœ¬é§…åº—', address: 'ç†Šæœ¬çœŒç†Šæœ¬å¸‚è¥¿åŒºæ˜¥æ—¥3ä¸ç›®15-30', prefecture: 'ç†Šæœ¬çœŒ', city: 'ç†Šæœ¬å¸‚', hours: '7:00-21:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ é¹¿å…å³¶ä¸­å¤®é§…åº—', address: 'é¹¿å…å³¶çœŒé¹¿å…å³¶å¸‚ä¸­å¤®ç”º1-1', prefecture: 'é¹¿å…å³¶çœŒ', city: 'é¹¿å…å³¶å¸‚', hours: '7:00-21:30', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] },
                { name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ é‚£è¦‡ç©ºæ¸¯åº—', address: 'æ²–ç¸„çœŒé‚£è¦‡å¸‚é¡æ°´150', prefecture: 'æ²–ç¸„çœŒ', city: 'é‚£è¦‡å¸‚', hours: '6:30-21:00', features: ['Wi-Fi', 'é›»æº', 'ç¦ç…™'] }
            ];
        }

        // Places API ã«ã‚ˆã‚‹æƒ…å ±è£œå®Œ
        async function enrichWithPlacesAPI() {
            if (stores.length === 0) {
                showGlobalStatus('âŒ è£œå®Œã™ã‚‹åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            if (!confirm(`${stores.length}åº—èˆ—ã®æƒ…å ±ã‚’Places APIã§è£œå®Œã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆAPIã‚¯ã‚©ãƒ¼ã‚¿ã‚’æ¶ˆè²»ã—ã¾ã™ï¼‰`)) {
                return;
            }

            const enrichmentResults = {
                total: stores.length,
                enriched: 0,
                failed: 0,
                needsManualAdjustment: []
            };

            showGlobalStatus('ğŸŒ Places API ã«ã‚ˆã‚‹æƒ…å ±è£œå®Œã‚’é–‹å§‹...', 'loading');
            
            for (let i = 0; i < stores.length; i++) {
                const store = stores[i];
                showGlobalStatus(`ğŸ“ å‡¦ç†ä¸­ ${i + 1}/${stores.length}: ${store.storeInfo.name}`, 'loading');

                try {
                    const enrichmentResult = await enrichStoreWithPlaces(store, i);
                    
                    if (enrichmentResult.success) {
                        enrichmentResults.enriched++;
                    } else {
                        enrichmentResults.failed++;
                        if (enrichmentResult.needsManualAdjustment) {
                            enrichmentResults.needsManualAdjustment.push({
                                index: i,
                                store: store,
                                reason: enrichmentResult.reason,
                                suggestions: enrichmentResult.suggestions || []
                            });
                        }
                    }

                    // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
                    await new Promise(resolve => setTimeout(resolve, 200));

                } catch (error) {
                    console.error(`ã‚¨ãƒ©ãƒ¼ (${store.storeInfo.name}):`, error);
                    enrichmentResults.failed++;
                }
            }

            // çµæœè¡¨ç¤º
            updateStoreList();
            updateStats();
            updateManualAdjustmentList(enrichmentResults.needsManualAdjustment);
            
            showGlobalStatus(
                `âœ… è£œå®Œå®Œäº†: æˆåŠŸ ${enrichmentResults.enriched}ä»¶ã€å¤±æ•— ${enrichmentResults.failed}ä»¶ã€è¦èª¿æ•´ ${enrichmentResults.needsManualAdjustment.length}ä»¶`,
                'success'
            );
        }

        // å€‹åˆ¥åº—èˆ—ã® Places API è£œå®Œ
        async function enrichStoreWithPlaces(store, index) {
            const queries = [
                `${store.storeInfo.name} ${store.storeInfo.address}`,
                `ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ ${store.storeInfo.address}`,
                `starbucks ${store.storeInfo.address}`,
                `${store.storeInfo.name} ${store.storeInfo.prefecture}`
            ];

            let bestMatch = null;
            let bestConfidence = 0;
            const allSuggestions = [];

            for (const query of queries) {
                try {
                    const placesResult = await searchPlacesAPI(query);
                    if (placesResult && placesResult.length > 0) {
                        for (const place of placesResult.slice(0, 3)) { // ä¸Šä½3ä»¶ã‚’è©•ä¾¡
                            const confidence = calculateMatchConfidence(store, place);
                            allSuggestions.push({ ...place, confidence, query });
                            
                            if (confidence > bestConfidence) {
                                bestMatch = place;
                                bestConfidence = confidence;
                            }
                        }
                    }
                } catch (error) {
                    console.log(`Placesæ¤œç´¢å¤±æ•— (${query}):`, error.message);
                }
            }

            // è‡ªå‹•é©ç”¨ã®é–¾å€¤åˆ¤å®š
            if (bestConfidence >= 0.8) {
                // é«˜ã„ä¿¡é ¼åº¦ - è‡ªå‹•é©ç”¨
                applyPlacesDataToStore(store, bestMatch);
                return { success: true, confidence: bestConfidence };
            } else if (bestConfidence >= 0.4) {
                // ä¸­ç¨‹åº¦ã®ä¿¡é ¼åº¦ - æ‰‹å‹•èª¿æ•´æ¨å¥¨
                return {
                    success: false,
                    needsManualAdjustment: true,
                    reason: `ä¿¡é ¼åº¦ãŒä¸­ç¨‹åº¦ (${(bestConfidence * 100).toFixed(1)}%)`,
                    suggestions: allSuggestions.sort((a, b) => b.confidence - a.confidence).slice(0, 3)
                };
            } else {
                // ä½ã„ä¿¡é ¼åº¦ - ä¿ç•™
                return {
                    success: false,
                    needsManualAdjustment: true,
                    reason: bestMatch ? `ä¿¡é ¼åº¦ãŒä½ã„ (${(bestConfidence * 100).toFixed(1)}%)` : 'ãƒãƒƒãƒã™ã‚‹åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                    suggestions: allSuggestions.slice(0, 3)
                };
            }
        }

        // Places API æ¤œç´¢ (ãƒ¢ãƒƒã‚¯å®Ÿè£…)
        async function searchPlacesAPI(query) {
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ Google Places API ã‚’ä½¿ç”¨
            // ã“ã“ã§ã¯ãƒ¢ãƒƒã‚¯å®Ÿè£…
            console.log(`Places API æ¤œç´¢: ${query}`);
            
            // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve([
                        {
                            name: query.includes('æ¸‹è°·') ? 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ æ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«ã‚¹ã‚¯ã‚¨ã‚¢åº—' : 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ ãƒ†ã‚¹ãƒˆåº—',
                            formatted_address: query.includes('æ¸‹è°·') ? 'æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·2-24-12' : 'æ±äº¬éƒ½ãƒ†ã‚¹ãƒˆåŒº1-1-1',
                            geometry: {
                                location: {
                                    lat: () => 35.658581 + (Math.random() - 0.5) * 0.01,
                                    lng: () => 139.701762 + (Math.random() - 0.5) * 0.01
                                }
                            },
                            formatted_phone_number: '03-1234-5678',
                            opening_hours: {
                                weekday_text: ['æœˆæ›œæ—¥: 6:30-22:30', 'ç«æ›œæ—¥: 6:30-22:30']
                            },
                            rating: 4.2,
                            types: ['cafe', 'store']
                        }
                    ]);
                }, 100);
            });
        }

        // ãƒãƒƒãƒãƒ³ã‚°ä¿¡é ¼åº¦è¨ˆç®—
        function calculateMatchConfidence(store, place) {
            let confidence = 0;

            // åº—èˆ—åã®é¡ä¼¼åº¦ (æœ€é‡è¦)
            const nameScore = calculateStringSimilarity(
                store.storeInfo.name.toLowerCase(),
                place.name.toLowerCase()
            );
            confidence += nameScore * 0.5;

            // ä½æ‰€ã®é¡ä¼¼åº¦
            const addressScore = calculateStringSimilarity(
                store.storeInfo.address,
                place.formatted_address
            );
            confidence += addressScore * 0.3;

            // ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            if (place.name.toLowerCase().includes('starbucks') || 
                place.name.toLowerCase().includes('ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹')) {
                confidence += 0.2;
            }

            return Math.min(confidence, 1.0);
        }

        // æ–‡å­—åˆ—é¡ä¼¼åº¦è¨ˆç®— (ç°¡æ˜“ç‰ˆ)
        function calculateStringSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            
            const commonChars = str1.split('').filter(char => str2.includes(char)).length;
            const maxLength = Math.max(str1.length, str2.length);
            
            return commonChars / maxLength;
        }

        // Places ãƒ‡ãƒ¼ã‚¿ã‚’åº—èˆ—ã«é©ç”¨
        function applyPlacesDataToStore(store, placesData) {
            // åº§æ¨™æƒ…å ±ã‚’æ›´æ–°
            if (placesData.geometry && placesData.geometry.location) {
                store.storeInfo.coordinates = {
                    latitude: placesData.geometry.location.lat(),
                    longitude: placesData.geometry.location.lng()
                };
            }

            // ãƒ“ã‚¸ãƒã‚¹æƒ…å ±ã‚’æ›´æ–°
            if (placesData.formatted_phone_number) {
                store.businessInfo.phone = placesData.formatted_phone_number;
            }

            if (placesData.opening_hours && placesData.opening_hours.weekday_text) {
                store.businessInfo.hours = placesData.opening_hours.weekday_text[0] || null;
            }

            // è¿½åŠ æƒ…å ±
            if (placesData.rating) {
                store.businessInfo.rating = placesData.rating;
            }

            // åŸºæœ¬çš„ãªè¨­å‚™æƒ…å ±ã‚’æ¨å®š
            if (!store.businessInfo.features || store.businessInfo.features.length === 0) {
                store.businessInfo.features = ['Wi-Fi', 'ç¦ç…™']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å‚™
            }
        }

        // æ‰‹å‹•èª¿æ•´ãƒªã‚¹ãƒˆæ›´æ–°
        function updateManualAdjustmentList(needsAdjustment) {
            const container = document.getElementById('manualAdjustmentList');
            
            if (needsAdjustment.length === 0) {
                container.innerHTML = '<p style="color: #28a745; text-align: center;">âœ… æ‰‹å‹•èª¿æ•´ãŒå¿…è¦ãªåº—èˆ—ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = needsAdjustment.map((item, idx) => `
                <div class="manual-adjustment-item" id="adjustment-${item.index}">
                    <h4>${item.store.storeInfo.name}</h4>
                    <p><strong>ä½æ‰€:</strong> ${item.store.storeInfo.address}</p>
                    <div class="adjustment-reason">
                        <strong>ç†ç”±:</strong> ${item.reason}
                    </div>
                    
                    ${item.suggestions.length > 0 ? `
                        <h5>ğŸ” å€™è£œåº—èˆ—</h5>
                        ${item.suggestions.map((suggestion, suggestionIdx) => `
                            <div class="places-suggestion">
                                <h5>${suggestion.name}</h5>
                                <p>${suggestion.formatted_address}</p>
                                <span class="confidence-score ${getConfidenceClass(suggestion.confidence)}">
                                    ä¿¡é ¼åº¦: ${(suggestion.confidence * 100).toFixed(1)}%
                                </span>
                                <div style="margin-top: 0.5rem;">
                                    <button class="btn" onclick="applyManualSuggestion(${item.index}, ${suggestionIdx}, ${idx})" style="font-size: 0.8rem; padding: 0.3rem 0.8rem;">
                                        âœ… é©ç”¨
                                    </button>
                                    <button class="btn-secondary btn" onclick="rejectSuggestion(${item.index}, ${suggestionIdx})" style="font-size: 0.8rem; padding: 0.3rem 0.8rem;">
                                        âŒ å´ä¸‹
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    ` : ''}
                    
                    <div class="adjustment-controls">
                        <button class="btn-secondary btn" onclick="skipManualAdjustment(${item.index})">
                            â­ï¸ ã‚¹ã‚­ãƒƒãƒ—
                        </button>
                        <button class="btn" onclick="editStoreManually(${item.index})">
                            âœï¸ æ‰‹å‹•ç·¨é›†
                        </button>
                        <button class="btn-danger btn" onclick="removeStoreFromAdjustment(${item.index})">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ä¿¡é ¼åº¦ã‚¯ãƒ©ã‚¹å–å¾—
        function getConfidenceClass(confidence) {
            if (confidence >= 0.7) return 'confidence-high';
            if (confidence >= 0.4) return 'confidence-medium';
            return 'confidence-low';
        }

        // æ‰‹å‹•èª¿æ•´æ“ä½œ
        function applyManualSuggestion(storeIndex, suggestionIndex, adjustmentIndex) {
            const adjustmentItems = document.querySelectorAll('.manual-adjustment-item');
            const adjustmentData = adjustmentItems[adjustmentIndex];
            
            // å€™è£œã‚’é©ç”¨
            // å®Ÿè£…ã¯ç°¡ç•¥åŒ–
            showGlobalStatus('âœ… å€™è£œã‚’é©ç”¨ã—ã¾ã—ãŸ', 'success');
            document.getElementById(`adjustment-${storeIndex}`).remove();
            updateStoreList();
        }

        function skipManualAdjustment(storeIndex) {
            if (confirm('ã“ã®åº—èˆ—ã®èª¿æ•´ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ')) {
                document.getElementById(`adjustment-${storeIndex}`).remove();
                showGlobalStatus('â­ï¸ èª¿æ•´ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ', 'success');
            }
        }

        function editStoreManually(storeIndex) {
            const store = stores[storeIndex];
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('storeName').value = store.storeInfo.name;
            document.getElementById('storeAddress').value = store.storeInfo.address;
            document.getElementById('storePrefecture').value = store.storeInfo.prefecture;
            document.getElementById('storePhone').value = store.businessInfo.phone || '';
            document.getElementById('storeHours').value = store.businessInfo.hours || '';
            document.getElementById('latitude').value = store.storeInfo.coordinates.latitude || '';
            document.getElementById('longitude').value = store.storeInfo.coordinates.longitude || '';
            document.getElementById('storeFeatures').value = store.businessInfo.features.join(', ');
            
            // å…ƒã®åº—èˆ—ã‚’å‰Šé™¤
            stores.splice(storeIndex, 1);
            updateStoreList();
            updateStats();
            
            showGlobalStatus('âœï¸ æ‰‹å‹•ç·¨é›†ç”¨ã«ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
            document.getElementById(`adjustment-${storeIndex}`).remove();
        }

        function removeStoreFromAdjustment(storeIndex) {
            if (confirm('ã“ã®åº—èˆ—ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                stores.splice(storeIndex, 1);
                updateStoreList();
                updateStats();
                document.getElementById(`adjustment-${storeIndex}`).remove();
                showGlobalStatus('ğŸ—‘ï¸ åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', function() {
            console.log('ğŸš€ Store List Creator Tool initialized');
            updateStats();
        });
    </script>

    <!-- Google Maps API (APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„) -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcx2v4xS9VuQjHzhME5Fz3Uazig3l62RI&libraries=geometry&callback=initMap">
    </script>
</body>
</html>